#!/bin/sh

echo "üîí Running pre-commit checks..."

# --------------------------------------------------
# 1. Block committing any .env files
# --------------------------------------------------
if git diff --cached --name-only | grep -E '(^|/)\.env(\.|$)' | grep -vE '\.env\.example$'; then
  echo "‚ùå Commit blocked: real .env files must NOT be committed."
  echo "‚úÖ .env.example is allowed."
  exit 1
fi


# --------------------------------------------------
# 2. Scan staged content for secrets using Gitleaks
# --------------------------------------------------
echo "üîç Scanning staged files for sensitive information..."

git diff --cached > /tmp/gitleaks.patch

gitleaks detect \
  --source /tmp/gitleaks.patch \
  --config .gitleaks.toml \
  --no-git \
  --verbose

if [ $? -ne 0 ]; then
  echo "‚ùå Commit blocked: Sensitive information detected."
  echo "‚û°Ô∏è  Remove secrets or move them to environment variables."
  exit 1
fi

echo "‚úÖ Pre-commit checks passed."
