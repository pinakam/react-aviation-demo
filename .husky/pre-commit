#!/bin/sh

echo "ğŸ”’ Running pre-commit checks..."

# --------------------------------------------------
# 1. Block committing any .env files
# --------------------------------------------------
if git diff --cached --name-only | grep -E '(^|/)\.env(\.|$)'; then
  echo "âŒ Commit blocked: .env files must NOT be committed."
  echo "â¡ï¸  Remove .env files from staging before committing."
  exit 1
fi

# --------------------------------------------------
# 2. Scan staged content for secrets using Gitleaks
# --------------------------------------------------
echo "ğŸ” Scanning staged files for sensitive information..."

git diff --cached > /tmp/gitleaks.patch

gitleaks detect \
  --source /tmp/gitleaks.patch \
  --config .gitleaks.toml \
  --no-git \
  --verbose

if [ $? -ne 0 ]; then
  echo "âŒ Commit blocked: Sensitive information detected."
  echo "â¡ï¸  Remove secrets or move them to environment variables."
  exit 1
fi

# --------------------------------------------------
# 3. Run lint-staged (code quality)
# --------------------------------------------------
echo "ğŸ§¹ Running lint-staged..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo "âŒ Commit blocked: lint-staged failed."
  exit 1
fi

echo "âœ… Pre-commit checks passed."
